<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMPIRE CRM - å°ˆæ¥­äºŒæ®µå¼ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --dark-gold: #8e6d13; --bg: #0a0a0a; --card-bg: #161616; }
        body { background-color: var(--bg); color: #d1d1d1; font-family: 'Noto Sans TC', sans-serif; overflow: hidden; }
        
        /* é é¢åˆ‡æ›å‹•ç•« */
        .page { display: none; height: 100vh; overflow-y: auto; padding-bottom: 80px; transition: all 0.3s ease; }
        .page.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å‘¼å¸ç™¼å…‰èˆ‡é‡‘å±¬æŒ‰éˆ• */
        .breath-border { border: 1px solid var(--dark-gold); animation: breathe 4s infinite ease-in-out; }
        @keyframes breathe {
            0%, 100% { border-color: var(--dark-gold); box-shadow: 0 0 5px rgba(212, 175, 55, 0.1); }
            50% { border-color: var(--gold); box-shadow: 0 0 15px rgba(212, 175, 55, 0.3); }
        }
        .gold-btn {
            background: linear-gradient(135deg, var(--dark-gold), var(--gold), var(--dark-gold));
            background-size: 200% 200%; animation: gold-flow 4s infinite linear;
            color: #000; font-weight: bold; border: none;
        }
        @keyframes gold-flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* é¢¨ç´å¼æŠ½å±œæ¨£å¼ */
        .accordion-header { background: #1a1a1a; border-left: 4px solid var(--gold); margin-bottom: 2px; }
        .accordion-content { background: #111; overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out; }
        .accordion-item.open .accordion-content { max-height: 500px; padding: 15px; border-bottom: 1px solid #333; }
        .accordion-item.open .chevron { transform: rotate(180deg); }

        /* åº•éƒ¨å°è¦½åˆ— */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #111; border-top: 1px solid #222; display: flex; z-index: 100; }
        .nav-item { flex: 1; text-align: center; padding: 15px; color: #555; font-size: 12px; transition: 0.3s; }
        .nav-item.active { color: var(--gold); font-weight: bold; }

        input, select, textarea { background: #1a1a1a !important; border: 1px solid #333 !important; color: #fff !important; }
    </style>
</head>
<body>

    <div id="page-add" class="page active px-6 pt-10">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-600">é¡§å®¢ç™»éŒ„</h1>
            <p class="text-[10px] text-gray-500 mt-2 uppercase">Empire Premium Entry</p>
        </header>

        <div class="breath-border rounded-2xl p-6 bg-zinc-950">
            <form id="lead-form" class="space-y-5">
                <input type="hidden" id="edit-id"> <div>
                    <label class="text-xs text-yellow-700 ml-1">å®¢æˆ¶å…¨å</label>
                    <input type="text" id="name" required class="w-full p-4 rounded-xl mt-1 draft-sync">
                </div>
                <div>
                    <label class="text-xs text-yellow-700 ml-1">è¯çµ¡é›»è©± / LINE</label>
                    <input type="text" id="contact" required class="w-full p-4 rounded-xl mt-1 draft-sync">
                </div>
                <div>
                    <label class="text-xs text-yellow-700 ml-1">ç›®å‰é–‹ç™¼éšæ®µ</label>
                    <select id="stage" class="w-full p-4 rounded-xl mt-1 draft-sync">
                        <option value="lead">æ–°é–‹ç™¼ (Lead)</option>
                        <option value="contacted">æ´½è«‡ä¸­ (Contacted)</option>
                        <option value="won">å·²æˆäº¤ (Won)</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-yellow-700 ml-1">é ç´„é …ç›®</label>
                        <input type="text" id="course" class="w-full p-4 rounded-xl mt-1 draft-sync">
                    </div>
                    <div>
                        <label class="text-xs text-yellow-700 ml-1">é ä¼°é‡‘é¡</label>
                        <input type="number" id="value" class="w-full p-4 rounded-xl mt-1 draft-sync">
                    </div>
                </div>
                <button type="submit" id="submit-btn" class="gold-btn w-full py-5 rounded-2xl shadow-2xl text-lg mt-4">ç¢ºèªå„²å­˜</button>
                <button type="button" id="cancel-edit" class="hidden w-full py-2 text-gray-500 text-sm">å–æ¶ˆä¿®æ”¹</button>
            </form>
        </div>
    </div>

    <div id="page-list" class="page px-4 pt-6">
        <header class="text-center mb-6">
            <h1 class="text-xl font-bold text-yellow-500 tracking-widest">é€²åº¦ç®¡ç†</h1>
        </header>

        <div class="space-y-4">
            <section class="bg-zinc-900 rounded-2xl overflow-hidden border border-zinc-800">
                <div class="p-4 bg-zinc-800/50 font-bold text-yellow-600 flex justify-between items-center">
                    <span>æ–°é–‹ç™¼ (Lead)</span>
                    <span id="count-lead" class="text-xs bg-black/40 px-2 py-1 rounded">0</span>
                </div>
                <div id="list-lead" class="divide-y divide-zinc-800"></div>
            </section>

            <section class="bg-zinc-900 rounded-2xl overflow-hidden border border-zinc-800">
                <div class="p-4 bg-zinc-800/50 font-bold text-yellow-600 flex justify-between items-center">
                    <span>æ´½è«‡ä¸­ (Contacted)</span>
                    <span id="count-contacted" class="text-xs bg-black/40 px-2 py-1 rounded">0</span>
                </div>
                <div id="list-contacted" class="divide-y divide-zinc-800"></div>
            </section>

            <section class="bg-zinc-900 rounded-2xl overflow-hidden border border-zinc-800">
                <div class="p-4 bg-zinc-800/50 font-bold text-green-700 flex justify-between items-center">
                    <span>å·²æˆäº¤ (Won)</span>
                    <span id="count-won" class="text-xs bg-black/40 px-2 py-1 rounded">0</span>
                </div>
                <div id="list-won" class="divide-y divide-zinc-800"></div>
            </section>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchPage('add', this)">
            <div class="text-xl mb-1">âœï¸</div>
            <div>å¡«å¯«è³‡æ–™</div>
        </div>
        <div class="nav-item" onclick="switchPage('list', this)">
            <div class="text-xl mb-1">ğŸ“Š</div>
            <div>é–‹ç™¼é€²åº¦</div>
        </div>
    </nav>

    <script>
        // --- Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const leadsRef = db.ref('leads');

        let localData = JSON.parse(localStorage.getItem('empire_v2_data')) || {};

        // 1. åˆ†é åˆ‡æ›
        function switchPage(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        // 2. å„²å­˜èˆ‡ä¿®æ”¹é‚è¼¯
        document.getElementById('lead-form').onsubmit = function(e) {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const id = editId || 'L' + Date.now();
            
            const leadData = {
                id: id,
                name: document.getElementById('name').value,
                contact: document.getElementById('contact').value,
                stage: document.getElementById('stage').value,
                course: document.getElementById('course').value,
                value: document.getElementById('value').value || 0,
                updatedAt: Date.now()
            };

            // æœ¬åœ°èˆ‡é›²ç«¯åŒæ­¥
            localData[id] = leadData;
            localStorage.setItem('empire_v2_data', JSON.stringify(localData));
            leadsRef.child(id).set(leadData);

            // é‡ç½®è¡¨å–®
            this.reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('submit-btn').innerText = "ç¢ºèªå„²å­˜";
            document.getElementById('cancel-edit').classList.add('hidden');
            localStorage.removeItem('entry_draft');
            
            alert(editId ? "ä¿®æ”¹æˆåŠŸ" : "ç™»éŒ„æˆåŠŸ");
            if(!editId) switchPage('list', document.querySelectorAll('.nav-item')[1]);
            renderUI();
        };

        // 3. æ¸²æŸ“é¢¨ç´å¼æŠ½å±œ
        function renderUI() {
            const groups = { lead: [], contacted: [], won: [] };
            Object.values(localData).forEach(item => {
                if(groups[item.stage]) groups[item.stage].push(item);
            });

            // æŒ‰æ›´æ–°æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            ['lead', 'contacted', 'won'].forEach(stage => {
                const listEl = document.getElementById('list-' + stage);
                const countEl = document.getElementById('count-' + stage);
                listEl.innerHTML = "";
                
                const sortedItems = groups[stage].sort((a,b) => b.updatedAt - a.updatedAt);
                countEl.innerText = sortedItems.length;

                sortedItems.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = "accordion-item";
                    itemEl.innerHTML = `
                        <div class="accordion-header p-4 flex justify-between items-center cursor-pointer" onclick="toggleAccordion(this)">
                            <div>
                                <span class="font-bold text-gray-100">${item.name}</span>
                                <span class="text-[10px] text-gray-500 ml-2">${new Date(item.updatedAt).toLocaleDateString()}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-yellow-600 font-black">$${Number(item.value).toLocaleString()}</span>
                                <span class="chevron text-xs transition-transform">â–¼</span>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="space-y-3 text-sm">
                                <p><span class="text-gray-500">è¯çµ¡æ–¹å¼ï¼š</span>${item.contact}</p>
                                <p><span class="text-gray-500">éœ€æ±‚é …ç›®ï¼š</span>${item.course || 'æœªå¡«'}</p>
                                <div class="flex gap-2 pt-2">
                                    <button onclick="editItem('${item.id}')" class="flex-1 py-2 bg-yellow-600/20 text-yellow-500 rounded-lg">ä¿®æ”¹è³‡æ–™</button>
                                    <button onclick="deleteItem('${item.id}')" class="flex-1 py-2 bg-red-900/20 text-red-500 rounded-lg">åˆªé™¤ç´€éŒ„</button>
                                </div>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(itemEl);
                });
            });
        }

        function toggleAccordion(header) {
            const item = header.parentElement;
            const isOpen = item.classList.contains('open');
            document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('open'));
            if (!isOpen) item.classList.add('open');
        }

        // 4. ä¿®æ”¹èˆ‡åˆªé™¤
        function editItem(id) {
            const item = localData[id];
            document.getElementById('edit-id').value = id;
            document.getElementById('name').value = item.name;
            document.getElementById('contact').value = item.contact;
            document.getElementById('stage').value = item.stage;
            document.getElementById('course').value = item.course;
            document.getElementById('value').value = item.value;
            
            document.getElementById('submit-btn').innerText = "ç¢ºèªä¿®æ”¹";
            document.getElementById('cancel-edit').classList.remove('hidden');
            switchPage('add', document.querySelectorAll('.nav-item')[0]);
        }

        function deleteItem(id) {
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                delete localData[id];
                localStorage.setItem('empire_v2_data', JSON.stringify(localData));
                leadsRef.child(id).remove();
                renderUI();
            }
        }

        // 5. Firebase åŒæ­¥èˆ‡åˆå§‹åŒ–
        leadsRef.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            localData = data;
            localStorage.setItem('empire_v2_data', JSON.stringify(localData));
            renderUI();
        });

        // 6. è‰ç¨¿åŠŸèƒ½
        document.querySelectorAll('.draft-sync').forEach(inp => {
            inp.oninput = () => {
                if(document.getElementById('edit-id').value) return; // ä¿®æ”¹æ¨¡å¼ä¸å­˜è‰ç¨¿
                const draft = {};
                document.querySelectorAll('.draft-sync').forEach(i => draft[i.id] = i.value);
                localStorage.setItem('entry_draft', JSON.stringify(draft));
            };
        });

        window.onload = () => {
            const draft = JSON.parse(localStorage.getItem('entry_draft'));
            if(draft && !document.getElementById('edit-id').value) {
                Object.keys(draft).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = draft[k]; });
            }
            renderUI();
        };

        document.getElementById('cancel-edit').onclick = function() {
            document.getElementById('lead-form').reset();
            document.getElementById('edit-id').value = "";
            this.classList.add('hidden');
            document.getElementById('submit-btn').innerText = "ç¢ºèªå„²å­˜";
        };
    </script>
</body>
</html>
