<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMPIRE CRM - æœ¬åœ°æ°¸çºŒç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --dark-gold: #8e6d13; --bg: #0a0a0a; --card-bg: #161616; }
        body { background-color: var(--bg); color: #d1d1d1; font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden; }
        
        /* å‘¼å¸ç™¼å…‰æ•ˆæœ */
        .breath-border { border: 1px solid var(--dark-gold); animation: breathe 4s infinite ease-in-out; }
        @keyframes breathe {
            0%, 100% { border-color: var(--dark-gold); box-shadow: 0 0 5px rgba(212, 175, 55, 0.2); }
            50% { border-color: var(--gold); box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
        }

        /* 4ç§’é‡‘å±¬æµå…‰æŒ‰éˆ• */
        .gold-btn {
            background: linear-gradient(135deg, var(--dark-gold), var(--gold), var(--dark-gold));
            background-size: 200% 200%; animation: gold-flow 4s infinite linear;
            color: #000; font-weight: bold; border: none;
        }
        @keyframes gold-flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* æ‰‹æ©Ÿçœ‹æ¿æ²å‹•å„ªåŒ– */
        .kanban-wrapper { display: flex; overflow-x: auto; gap: 1rem; padding: 1rem; scroll-snap-type: x mandatory; }
        .kanban-column { flex: 0 0 85vw; scroll-snap-align: center; background: rgba(15, 15, 15, 0.95); border-radius: 20px; padding: 1.25rem; min-height: 60vh; border: 1px solid #1a1a1a; }
        
        .customer-card { background: var(--card-bg); border: 1px solid #2a2a2a; border-radius: 12px; margin-bottom: 0.75rem; padding: 1.25rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        #details-modal { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); align-items: center; justify-content: center; padding: 1.5rem; }
        input, select { background: #1a1a1a !important; border: 1px solid #333 !important; color: #fff !important; }
        
        .status-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .sync-local { background: #1e3a8a; color: #bfdbfe; } /* æœ¬åœ°å„²å­˜ä¸­ */
        .sync-cloud { background: #064e3b; color: #a7f3d0; } /* é›²ç«¯å·²å‚™ä»½ */
    </style>
</head>
<body class="pb-24">

    <header class="p-6 text-center">
        <h1 class="text-2xl font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-yellow-100 to-yellow-600">EMPIRE CRM</h1>
        <div id="connection-indicator" class="text-[10px] mt-2 text-gray-500">ç³»çµ±ç‹€æ…‹ï¼šåˆå§‹åŒ–æœ¬åœ°æ•¸æ“šåº«...</div>
    </header>

    <div class="px-4 mb-6">
        <details class="breath-border rounded-xl p-4 bg-zinc-950" id="form-container">
            <summary class="text-yellow-500 font-medium cursor-pointer text-center list-none font-bold">ï¼‹ å¿«é€Ÿç™»éŒ„è³‡æ–™ (é˜²é–ƒé€€æ¨¡å¼)</summary>
            <form id="lead-form" class="mt-4 space-y-4">
                <input type="text" id="name" placeholder="å®¢æˆ¶å…¨å" required class="w-full p-4 rounded-xl draft-sync">
                <input type="text" id="contact" placeholder="é›»è©± / LINE ID" required class="w-full p-4 rounded-xl draft-sync">
                
                <div class="space-y-1">
                    <label class="text-[10px] text-yellow-700 ml-1 tracking-widest">ç›®å‰é–‹ç™¼éšæ®µ</label>
                    <select id="stage" class="w-full p-4 rounded-xl draft-sync">
                        <option value="lead">æ–°é–‹ç™¼ (Lead)</option>
                        <option value="contacted">æ´½è«‡ä¸­ (Contacted)</option>
                        <option value="won">å·²æˆäº¤ (Won)</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="course" placeholder="é …ç›®å…§å®¹" class="p-4 rounded-xl draft-sync">
                    <input type="number" id="value" placeholder="é ä¼°é ç®—" class="p-4 rounded-xl draft-sync">
                </div>
                <button type="submit" class="gold-btn w-full py-4 rounded-xl shadow-2xl text-lg">ç¢ºèªå„²å­˜è‡³æœ¬åœ°èˆ‡é›²ç«¯</button>
            </form>
        </details>
    </div>

    <div class="kanban-wrapper">
        <div class="kanban-column" data-stage="lead">
            <h2 class="text-yellow-600 font-bold mb-4 flex justify-between"><span>æ–°é–‹ç™¼</span> <span class="count text-xs">0</span></h2>
            <div id="lead-list" class="stage-list min-h-[300px]"></div>
        </div>
        <div class="kanban-column" data-stage="contacted">
            <h2 class="text-yellow-600 font-bold mb-4 flex justify-between"><span>æ´½è«‡ä¸­</span> <span class="count text-xs">0</span></h2>
            <div id="contacted-list" class="stage-list min-h-[300px]"></div>
        </div>
        <div class="kanban-column" data-stage="won">
            <h2 class="text-green-500 font-bold mb-4 flex justify-between"><span>å·²æˆäº¤</span> <span class="count text-xs">0</span></h2>
            <div id="won-list" class="stage-list min-h-[300px]"></div>
        </div>
    </div>

    <div id="details-modal">
        <div class="bg-zinc-900 border border-yellow-700 w-full max-w-xs rounded-3xl p-8 relative">
            <div id="modal-status-tag" class="mb-2"></div>
            <h2 id="m-name" class="text-3xl font-bold text-yellow-500 mb-6"></h2>
            <div class="space-y-5 text-sm" id="m-body"></div>
            <div class="mt-10 flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-4 rounded-2xl bg-zinc-800 text-white font-bold">é—œé–‰</button>
                <button id="m-delete" class="px-6 py-4 rounded-2xl bg-red-900/20 text-red-500 font-bold">åˆªé™¤</button>
            </div>
        </div>
    </div>

    <script>
        // --- è«‹æ›´æ›ç‚ºæ‚¨çš„ Firebase é…ç½® ---
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
  authDomain: "holyhairsalon-f73bf.firebaseapp.com",
  databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
  projectId: "holyhairsalon-f73bf",
  storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
  messagingSenderId: "960169055224",
  appId: "1:960169055224:web:82244b5e65983f89bf3c0d",
  measurementId: "G-XS22B43TYM"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

        // 1. åˆå§‹åŒ–ç’°å¢ƒ
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const leadsRef = db.ref('leads');
        
        // æœ¬åœ°ä¸»è³‡æ–™åº«
        let localData = JSON.parse(localStorage.getItem('empire_crm_data')) || {};

        // 2. é é¢è¼‰å…¥ï¼šå„ªå…ˆæ¸²æŸ“æœ¬åœ°è³‡æ–™
        window.addEventListener('DOMContentLoaded', () => {
            renderUI(localData);
            restoreDraft();
            
            // éš¨å¾ŒåŒæ­¥é›²ç«¯è³‡æ–™
            leadsRef.on('value', (snapshot) => {
                const cloudData = snapshot.val() || {};
                localData = cloudData;
                saveToLocal();
                renderUI(localData);
                document.getElementById('connection-indicator').innerHTML = "ğŸŸ¢ é›²ç«¯åŒæ­¥æˆåŠŸ";
            }, (error) => {
                document.getElementById('connection-indicator').innerHTML = "ğŸŸ¡ é›¢ç·šæ¨¡å¼ï¼šåƒ…ä½¿ç”¨æœ¬åœ°å„²å­˜";
            });
        });

        // 3. å„²å­˜é‚è¼¯ (æœ¬åœ°å„ªå…ˆ)
        document.getElementById('lead-form').onsubmit = function(e) {
            e.preventDefault();
            const id = 'lead_' + Date.now();
            const newLead = {
                id: id,
                name: document.getElementById('name').value,
                contact: document.getElementById('contact').value,
                stage: document.getElementById('stage').value,
                course: document.getElementById('course').value,
                value: document.getElementById('value').value || 0,
                sync: false // æ¨™è¨˜å°šæœªåŒæ­¥è‡³é›²ç«¯
            };

            // ç«‹å³å­˜å…¥æœ¬åœ°ä¸¦æ›´æ–° UI
            localData[id] = newLead;
            saveToLocal();
            renderUI(localData);
            
            // å˜—è©¦å¯«å…¥é›²ç«¯
            leadsRef.child(id).set(newLead).then(() => {
                localData[id].sync = true;
                saveToLocal();
            });

            // æ¸…é™¤è‰ç¨¿èˆ‡é‡ç½®
            this.reset();
            localStorage.removeItem('crm_draft');
            document.getElementById('form-container').open = false;
        };

        // 4. é˜²é–ƒé€€ï¼šè‰ç¨¿ç›£è½
        document.querySelectorAll('.draft-sync').forEach(input => {
            input.oninput = () => {
                const draft = {};
                document.querySelectorAll('.draft-sync').forEach(i => draft[i.id] = i.value);
                localStorage.setItem('crm_draft', JSON.stringify(draft));
            };
        });

        function restoreDraft() {
            const draft = JSON.parse(localStorage.getItem('crm_draft'));
            if(draft) {
                Object.keys(draft).forEach(id => {
                    if(document.getElementById(id)) document.getElementById(id).value = draft[id];
                });
                if(draft.name) document.getElementById('form-container').open = true;
            }
        }

        // 5. æ¸²æŸ“å‡½æ•¸
        function renderUI(data) {
            document.querySelectorAll('.stage-list').forEach(el => el.innerHTML = '');
            Object.keys(data).forEach(id => {
                const item = data[id];
                const card = document.createElement('div');
                card.className = 'customer-card';
                card.dataset.id = id;
                card.onclick = () => openModal(id, item);
                card.innerHTML = `
                    <div class="flex justify-between items-center font-bold">
                        <span class="text-gray-100">${item.name}</span>
                        <span class="text-yellow-600 text-sm">$${Number(item.value).toLocaleString()}</span>
                    </div>
                `;
                const list = document.getElementById(`${item.stage}-list`);
                if(list) list.appendChild(card);
            });
            updateCounts();
        }

        function saveToLocal() {
            localStorage.setItem('empire_crm_data', JSON.stringify(localData));
        }

        function updateCounts() {
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.querySelector('.count').innerText = col.querySelectorAll('.customer-card').length;
            });
        }

        // 6. è©³æƒ…å½ˆçª—
        function openModal(id, item) {
            document.getElementById('m-name').innerText = item.name;
            document.getElementById('modal-status-tag').innerHTML = item.sync ? 
                '<span class="status-tag sync-cloud">é›²ç«¯å·²åŠ å¯†</span>' : 
                '<span class="status-tag sync-local">æœ¬åœ°å„²å­˜ä¸­</span>';
            
            document.getElementById('m-body').innerHTML = `
                <div class="border-b border-zinc-800 pb-2"><label class="text-gray-500 text-xs tracking-widest">è¯çµ¡é›»è©±/LINE</label><p class="text-lg text-white font-medium">${item.contact}</p></div>
                <div class="border-b border-zinc-800 pb-2"><label class="text-gray-500 text-xs tracking-widest">é ç´„é …ç›®</label><p class="text-white">${item.course || 'å°ˆå±¬è«®è©¢'}</p></div>
                <div class="border-b border-zinc-800 pb-2"><label class="text-gray-500 text-xs tracking-widest">æˆäº¤åƒ¹å€¼</label><p class="text-yellow-500 text-2xl font-black">$ ${Number(item.value).toLocaleString()}</p></div>
            `;
            
            document.getElementById('m-delete').onclick = () => {
                if(confirm('åˆªé™¤å°‡ç„¡æ³•é‚„åŸï¼Œç¢ºå®šï¼Ÿ')) {
                    delete localData[id];
                    saveToLocal();
                    leadsRef.child(id).remove();
                    renderUI(localData);
                    closeModal();
                }
            };
            document.getElementById('details-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('details-modal').style.display = 'none'; }

        // æ‹–æ‹½åŒæ­¥æ›´æ–°
        document.querySelectorAll('.stage-list').forEach(list => {
            new Sortable(list, {
                group: 'kanban', animation: 150,
                onEnd: (evt) => {
                    const id = evt.item.dataset.id;
                    const newStage = evt.to.parentElement.dataset.stage;
                    if(localData[id]) {
                        localData[id].stage = newStage;
                        saveToLocal();
                        leadsRef.child(id).update({ stage: newStage });
                        updateCounts();
                    }
                }
            });
        });
    </script>
</body>
</html>
