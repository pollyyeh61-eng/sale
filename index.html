<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMPIRE CRM - æ™ºæ…§é€£å‹•ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --gold-bright: #fde68a; --bg: #050505; }
        body { background: var(--bg); color: var(--gold); font-family: 'Noto Sans TC', sans-serif; }
        
        .text-gold {
            background: linear-gradient(135deg, #fff6d5, #d4af37, #8e6d13);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .glass-panel {
            background: rgba(25, 25, 25, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 20px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .accordion-content {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s ease;
            background: rgba(0, 0, 0, 0.4);
        }

        .active .accordion-content { max-height: 500px; border-top: 1px solid rgba(212, 175, 55, 0.1); }

        .btn-gold {
            background: linear-gradient(to bottom, #fde68a, #d4af37);
            color: #1a1100; font-weight: 900; padding: 12px;
            border-radius: 12px; border: none; font-size: 0.9rem;
        }

        input, select {
            background: rgba(0,0,0,0.5) !important;
            border: 1px solid #444 !important;
            color: var(--gold-bright) !important;
            padding: 12px !important; border-radius: 12px !important;
            width: 100%; outline: none;
        }
        .search-bar { border: 1px solid var(--gold) !important; background: rgba(212, 175, 55, 0.05) !important; }
    </style>
</head>
<body class="p-4 pb-24">

    <header class="py-4 text-center">
        <h1 class="text-3xl font-black text-gold tracking-widest">EMPIRE CRM</h1>
    </header>

    <div class="mb-6">
        <input type="text" id="search-input" placeholder="ğŸ” æœå°‹å®¢æˆ¶å§“åæˆ–é …ç›®..." class="search-bar">
    </div>

    <div class="glass-panel p-5 mb-8 border-yellow-600/30 border">
        <h2 class="text-xs font-bold text-yellow-800 mb-4 tracking-[0.2em]">NEW REGISTRATION</h2>
        <div class="space-y-3">
            <input type="text" id="ipt-name" placeholder="å®¢æˆ¶å°Šç¨± (è¼¸å…¥èˆŠåè‡ªå‹•å¸¶å…¥)">
            <div class="grid grid-cols-2 gap-2">
                <input type="text" id="ipt-course" placeholder="é …ç›®">
                <input type="number" id="ipt-value" placeholder="é‡‘é¡">
            </div>
            <select id="ipt-stage">
                <option value="lead">ğŸ†• æ–°é–‹ç™¼ (LEAD)</option>
                <option value="contacted">ğŸ¤ æ´½è«‡ä¸­ (DEAL)</option>
                <option value="won">ğŸ’° å·²æˆäº¤ (WON)</option>
            </select>
            <input type="text" id="ipt-contact" placeholder="è¯çµ¡è³‡è¨Š">
            <button id="btn-save" class="btn-gold w-full mt-2">å„²å­˜å°Šæ¦®ç´€éŒ„</button>
        </div>
    </div>

    <div id="main-kanban"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
            authDomain: "holyhairsalon-f73bf.firebaseapp.com",
            databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
            projectId: "holyhairsalon-f73bf",
            storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
            messagingSenderId: "960169055224",
            appId: "1:960169055224:web:82244b5e65983f89bf3c0d",
            measurementId: "G-XS22B43TYM"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let allLeads = {}; // ç”¨æ–¼å¿«å–æ‰€æœ‰è³‡æ–™

        // --- åŠŸèƒ½ A: å§“åé€£å‹•åµæ¸¬ ---
        document.getElementById('ipt-name').addEventListener('input', function(e) {
            const name = e.target.value.trim();
            if(!name) return;
            
            // å¾æ­·å²ç´€éŒ„å°‹æ‰¾æœ€å¾Œä¸€ç­†åŒåè³‡æ–™
            const history = Object.values(allLeads).reverse().find(l => l.name === name);
            if(history) {
                document.getElementById('ipt-contact').value = history.contact || '';
                document.getElementById('ipt-course').value = history.course || '';
                // è¼•å¾®æŠ–å‹•æç¤ºå·²è‡ªå‹•å¸¶å…¥ (å¯é¸)
            }
        });

        // --- åŠŸèƒ½ B: æœå°‹éæ¿¾ ---
        document.getElementById('search-input').addEventListener('input', () => renderUI(allLeads));

        // å„²å­˜
        document.getElementById('btn-save').addEventListener('click', () => {
            const name = document.getElementById('ipt-name').value;
            if(!name) return alert("è«‹è¼¸å…¥å§“å");
            
            const data = {
                name: name,
                course: document.getElementById('ipt-course').value || "",
                value: document.getElementById('ipt-value').value || 0,
                stage: document.getElementById('ipt-stage').value,
                contact: document.getElementById('ipt-contact').value || "",
                time: Date.now()
            };

            database.ref('leads').push(data).then(() => {
                document.getElementById('ipt-name').value = '';
                document.getElementById('ipt-contact').value = '';
                document.getElementById('ipt-course').value = '';
                document.getElementById('ipt-value').value = '';
            });
        });

        // ç›£è½é›²ç«¯
        database.ref('leads').on('value', (snapshot) => {
            allLeads = snapshot.val() || {};
            renderUI(allLeads);
        });

        function renderUI(data) {
            const kanban = document.getElementById('main-kanban');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            kanban.innerHTML = '';

            const stages = { lead: 'æ–°é–‹ç™¼', contacted: 'æ´½è«‡ä¸­', won: 'å·²æˆäº¤' };
            
            for (let key in stages) {
                const items = Object.keys(data).filter(id => {
                    const matchSearch = data[id].name.toLowerCase().includes(searchTerm) || 
                                       data[id].course.toLowerCase().includes(searchTerm);
                    return data[id].stage === key && matchSearch;
                });
                
                let section = `<div class="mb-8"><h2 class="text-xl font-black text-gold mb-3 px-2">${stages[key]} (${items.length})</h2>`;

                items.reverse().forEach(id => {
                    const item = data[id];
                    section += `
                        <div class="accordion-item glass-panel" id="card-${id}">
                            <div class="p-5 flex justify-between items-center" onclick="document.getElementById('card-${id}').classList.toggle('active')">
                                <div>
                                    <div class="text-xl font-bold text-white">${item.name}</div>
                                    <div class="text-[10px] text-yellow-800 tracking-widest uppercase">${item.course}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-black text-gold">$${Number(item.value).toLocaleString()}</div>
                                    <div class="text-[10px] text-yellow-900 italic">DETAILS â–¼</div>
                                </div>
                            </div>
                            
                            <div class="accordion-content p-5 space-y-4">
                                <div>
                                    <label class="text-[10px] text-yellow-700">ä¿®æ”¹é …ç›®åç¨±</label>
                                    <input type="text" id="edit-course-${id}" value="${item.course}">
                                </div>
                                <div>
                                    <label class="text-[10px] text-yellow-700">ä¿®æ”¹è¯çµ¡è³‡è¨Š</label>
                                    <input type="text" id="edit-contact-${id}" value="${item.contact}">
                                </div>
                                <div>
                                    <label class="text-[10px] text-yellow-700">ä¿®æ”¹æˆäº¤é‡‘é¡</label>
                                    <input type="number" id="edit-value-${id}" value="${item.value}">
                                </div>
                                <div class="flex gap-2 pt-2">
                                    <button onclick="updateRec('${id}')" class="btn-gold flex-1">å„²å­˜ä¿®æ”¹</button>
                                    <button onclick="deleteRec('${id}')" class="bg-red-950/30 text-red-600 px-4 rounded-xl text-xs font-bold border border-red-900/30">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                section += `</div>`;
                kanban.innerHTML += section;
            }
        }

        // --- åŠŸèƒ½ C: ä¿®æ”¹ç´€éŒ„ ---
        function updateRec(id) {
            const newCourse = document.getElementById(`edit-course-${id}`).value;
            const newContact = document.getElementById(`edit-contact-${id}`).value;
            const newValue = document.getElementById(`edit-value-${id}`).value;

            database.ref('leads').child(id).update({
                course: newCourse,
                contact: newContact,
                value: newValue
            }).then(() => {
                alert("ä¿®æ”¹æˆåŠŸ");
                document.getElementById(`card-${id}`).classList.remove('active');
            });
        }

        function deleteRec(id) {
            if(confirm('ç¢ºå®šè¦ç§»é™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) database.ref('leads').child(id).remove();
        }
    </script>
</body>
</html>
