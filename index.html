<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMPIRE CRM - LUXURY EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --gold-bright: #fde68a; 
            --gold-main: #d4af37; 
            --gold-dark: #8e6d13;
            --bg-black: #050505;
        }
        
        body { 
            background: var(--bg-black); 
            color: var(--gold-main); 
            font-family: 'Noto Sans TC', sans-serif; 
            overflow-x: hidden;
        }

        /* æ¼¸å±¤é‡‘å±¬å­— - å¾¹åº•å‘Šåˆ¥ç°ç™½ */
        .text-gradient-gold {
            background: linear-gradient(to bottom, #fff6d5 0%, #d4af37 50%, #8e6d13 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }

        /* æ¯›ç»ç’ƒå¥¢è¯åº•å±¤ */
        .glass-panel {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 24px;
        }

        /* å‹•æ…‹æµå‹•é‡‘å…‰é‚Šæ¡† */
        .flow-border-box {
            position: relative;
            border-radius: 24px;
            padding: 1px;
            background: linear-gradient(90deg, transparent, var(--gold-main), transparent, var(--gold-bright), transparent);
            background-size: 200% 100%;
            animation: flowGold 5s linear infinite;
        }
        @keyframes flowGold {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* æ‰‹é¢¨ç´å‹•æ…‹ */
        .accordion-content {
            max-height: 0; overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(10, 10, 10, 0.5);
        }
        .active .accordion-content { max-height: 600px; padding: 20px; border-top: 1px solid rgba(212, 175, 55, 0.1); }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ•ï¼šé‡‘åº•é»‘å­—æˆ–é»‘åº•é‡‘é‚Š */
        input, select {
            background: rgba(0,0,0,0.6) !important;
            border: 1px solid var(--gold-dark) !important;
            color: var(--gold-bright) !important;
            padding: 16px !important; border-radius: 14px !important;
            outline: none; font-size: 1.1rem;
        }
        input::placeholder { color: var(--gold-dark); opacity: 0.6; }

        .btn-gold-action {
            background: linear-gradient(180deg, var(--gold-bright), var(--gold-main));
            color: #000; font-weight: 900; padding: 16px;
            border-radius: 16px; border: none; width: 100%;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.2);
            cursor: pointer;
        }
        .btn-gold-action:active { transform: scale(0.97); }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 10px; }
    </style>
</head>
<body class="p-4 pb-24">

    <header class="py-8 text-center">
        <h1 class="text-4xl tracking-widest text-gradient-gold">EMPIRE CRM</h1>
        <p id="local-status" class="text-[10px] text-yellow-900 mt-2 font-black italic tracking-widest">LOCAL ENCRYPTION ACTIVE</p>
    </header>

    <div class="mb-6">
        <input type="text" id="search-input" placeholder="ğŸ” æœå°‹å°Šæ¦®å®¢æˆ¶æˆ–é …ç›®..." class="w-full">
    </div>

    <div class="flow-border-box mb-10">
        <div class="glass-panel p-6">
            <h2 class="text-sm font-black text-gradient-gold mb-5 tracking-[0.3em] text-center">CLIENT REGISTRATION</h2>
            <div class="space-y-4">
                <input type="text" id="ipt-name" placeholder="å®¢æˆ¶å°Šç¨± (è¼¸å…¥è‡ªå‹•è¯æƒ³æ­·å²)" class="draft-save">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="ipt-course" placeholder="éœ€æ±‚é …ç›®" class="draft-save">
                    <input type="number" id="ipt-value" placeholder="é ç®—é‡‘é¡" class="draft-save">
                </div>
                <select id="ipt-stage" class="draft-save">
                    <option value="lead">æ–°é–‹ç™¼éšæ®µ (LEAD)</option>
                    <option value="contacted">æ´½è«‡ä¸­éšæ®µ (DEAL)</option>
                    <option value="won">æˆäº¤ç´€éŒ„ (WON)</option>
                </select>
                <input type="text" id="ipt-contact" placeholder="è¯çµ¡è³‡è¨Š / è©³ç´°å‚™è¨»" class="draft-save">
                <button id="btn-save" class="btn-gold-action mt-2">ç¢ºèªåŒæ­¥è‡³é›²ç«¯èˆ‡æœ¬åœ°</button>
            </div>
        </div>
    </div>

    <div id="kanban-display" class="space-y-8"></div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
            authDomain: "holyhairsalon-f73bf.firebaseapp.com",
            databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
            projectId: "holyhairsalon-f73bf",
            storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
            messagingSenderId: "960169055224",
            appId: "1:960169055224:web:82244b5e65983f89bf3c0d",
            measurementId: "G-XS22B43TYM"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let allLeads = JSON.parse(localStorage.getItem('empire_local_leads')) || {};

        // --- åŠŸèƒ½ 1: LocalStorage è‡ªå‹•æš«å­˜è‰ç¨¿ (é˜²éºå¤±) ---
        const draftFields = document.querySelectorAll('.draft-save');
        draftFields.forEach(field => {
            // æ¢å¾©è‰ç¨¿
            const savedDraft = localStorage.getItem('crm_draft_' + field.id);
            if(savedDraft) field.value = savedDraft;

            // æ¯æ‰“ä¸€å€‹å­—å°±å­˜
            field.addEventListener('input', () => {
                localStorage.setItem('crm_draft_' + field.id, field.value);
                
                // é¡å¤–åŠŸèƒ½ï¼šå§“åè¯å‹•
                if(field.id === 'ipt-name') {
                    const match = Object.values(allLeads).reverse().find(l => l.name === field.value.trim());
                    if(match) {
                        document.getElementById('ipt-contact').value = match.contact;
                        document.getElementById('ipt-course').value = match.course;
                    }
                }
            });
        });

        // --- åŠŸèƒ½ 2: é›²ç«¯åŒæ­¥ä¸¦å‚™ä»½è‡³æœ¬åœ° ---
        database.ref('leads').on('value', (snapshot) => {
            const data = snapshot.val() || {};
            allLeads = data;
            localStorage.setItem('empire_local_leads', JSON.stringify(data));
            renderUI(data);
        });

        function renderUI(data) {
            const display = document.getElementById('kanban-display');
            const search = document.getElementById('search-input').value.toLowerCase();
            display.innerHTML = '';

            const stages = { lead: 'æ–°é–‹ç™¼', contacted: 'æ´½è«‡ä¸­', won: 'å·²æˆäº¤ç´€éŒ„' };
            
            for (let s in stages) {
                const filtered = Object.keys(data).filter(id => {
                    const l = data[id];
                    return l.stage === s && (l.name.toLowerCase().includes(search) || l.course.toLowerCase().includes(search));
                });

                let html = `
                    <div>
                        <div class="flex justify-between items-center mb-4 px-2">
                            <span class="text-2xl font-black text-gradient-gold">${stages[s]}</span>
                            <span class="text-xs font-bold text-yellow-900 tracking-widest">${filtered.length} CLIENTS</span>
                        </div>
                `;

                filtered.reverse().forEach(id => {
                    const item = data[id];
                    html += `
                        <div class="glass-panel mb-4" id="parent-${id}">
                            <div class="p-6 flex justify-between items-center" onclick="document.getElementById('parent-${id}').classList.toggle('active')">
                                <div>
                                    <div class="text-2xl font-bold text-yellow-100">${item.name}</div>
                                    <div class="text-[10px] text-yellow-700 tracking-[0.2em] uppercase mt-1">${item.course}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-black text-gradient-gold">$${Number(item.value).toLocaleString()}</div>
                                    <div class="text-[9px] text-yellow-900 mt-1 italic">ENCRYPTED VIEW â–¼</div>
                                </div>
                            </div>
                            
                            <div class="accordion-content">
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-[10px] text-yellow-700 uppercase tracking-widest">è¯çµ¡è³‡è¨Š/å‚™è¨»</label>
                                        <input type="text" id="edit-contact-${id}" value="${item.contact}" class="mt-1">
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-[10px] text-yellow-700 uppercase tracking-widest">é …ç›®ä¿®æ”¹</label>
                                            <input type="text" id="edit-course-${id}" value="${item.course}">
                                        </div>
                                        <div>
                                            <label class="text-[10px] text-yellow-700 uppercase tracking-widest">é‡‘é¡æ›´æ–°</label>
                                            <input type="number" id="edit-value-${id}" value="${item.value}">
                                        </div>
                                    </div>
                                    <div class="flex gap-3 pt-4">
                                        <button onclick="updateData('${id}')" class="btn-gold-action flex-[2]">ä¿å­˜ä¿®æ”¹</button>
                                        <button onclick="deleteData('${id}')" class="flex-1 bg-red-950/20 text-red-700 rounded-xl font-bold border border-red-900/20 text-xs">åˆªé™¤</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                display.innerHTML += html + '</div>';
            }
        }

        // å„²å­˜æŒ‰éˆ•
        document.getElementById('btn-save').addEventListener('click', () => {
            const name = document.getElementById('ipt-name').value;
            if(!name) return alert("è«‹è¼¸å…¥å®¢æˆ¶å°Šç¨±");

            const payload = {
                name: name,
                course: document.getElementById('ipt-course').value || "å°ˆå±¬è¨­è¨ˆ",
                value: document.getElementById('ipt-value').value || 0,
                stage: document.getElementById('ipt-stage').value,
                contact: document.getElementById('ipt-contact').value || "æœªå‚™è¨»",
                time: Date.now()
            };

            database.ref('leads').push(payload).then(() => {
                // æ¸…é™¤æœ¬åœ°è‰ç¨¿
                draftFields.forEach(f => {
                    f.value = '';
                    localStorage.removeItem('crm_draft_' + f.id);
                });
                alert("âœ¨ è³‡æ–™å·²å®Œæˆé›™é‡åŠ å¯†å­˜å„²");
            });
        });

        function updateData(id) {
            const updates = {
                course: document.getElementById(`edit-course-${id}`).value,
                contact: document.getElementById(`edit-contact-${id}`).value,
                value: document.getElementById(`edit-value-${id}`).value
            };
            database.ref('leads').child(id).update(updates).then(() => {
                alert("ä¿®æ”¹å·²åŒæ­¥");
                document.getElementById(`parent-${id}`).classList.remove('active');
            });
        }

        function deleteData(id) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤å®¢æˆ¶çš„æ‰€æœ‰å°Šæ¦®ç´€éŒ„ï¼Ÿ')) database.ref('leads').child(id).remove();
        }

        document.getElementById('search-input').addEventListener('input', () => renderUI(allLeads));
    </script>
</body>
</html>
