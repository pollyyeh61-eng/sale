<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMPIRE CRM - 智慧填載版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --gold: #d4af37; --dark-gold: #8e6d13; --bg: #0a0a0a; --card-bg: #161616; }
        body { background-color: var(--bg); color: #d1d1d1; font-family: 'Noto Sans TC', sans-serif; }
        
        /* 滾動條美化 */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--dark-gold); border-radius: 10px; }

        .breath-border { border: 1px solid var(--dark-gold); animation: breathe 4s infinite ease-in-out; }
        @keyframes breathe {
            0%, 100% { border-color: var(--dark-gold); box-shadow: 0 0 5px rgba(212, 175, 55, 0.1); }
            50% { border-color: var(--gold); box-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
        }

        .gold-btn {
            background: linear-gradient(135deg, var(--dark-gold), var(--gold), var(--dark-gold));
            background-size: 200% 200%; animation: gold-flow 4s infinite linear;
            color: #000; font-weight: bold; border: none;
        }
        @keyframes gold-flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* 風琴式抽屜 */
        .accordion-content { overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out; }
        .accordion-item.open .accordion-content { max-height: 300px; padding: 12px; border-top: 1px solid #222; }
        .accordion-item.open .chevron { transform: rotate(180deg); }

        input, select { background: #1a1a1a !important; border: 1px solid #333 !important; color: #fff !important; font-size: 14px !important; }
        .hint-text { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-4 pb-10">

    <header class="text-center mb-4">
        <h1 class="text-xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-600">EMPIRE SALES CRM</h1>
    </header>

    <section class="mb-6">
        <div class="breath-border rounded-xl p-4 bg-zinc-950 shadow-2xl">
            <div id="match-hint" class="hidden text-[10px] text-yellow-500 mb-2 hint-text font-bold">✨ 偵測到舊有記錄，已自動為您填入</div>
            <form id="lead-form" class="space-y-3">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="name" placeholder="客戶全名" required class="p-3 rounded-lg w-full">
                    <input type="text" id="contact" placeholder="電話 / LINE" required class="p-3 rounded-lg w-full">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="course" placeholder="項目" class="p-3 rounded-lg w-full">
                    <input type="number" id="value" placeholder="金額" class="p-3 rounded-lg w-full">
                </div>
                <div class="flex gap-2">
                    <select id="stage" class="p-3 rounded-lg flex-1">
                        <option value="lead">新開發</option>
                        <option value="contacted">洽談中</option>
                        <option value="won">已成交</option>
                    </select>
                    <button type="submit" id="submit-btn" class="gold-btn px-6 py-3 rounded-lg shadow-lg">儲存記錄</button>
                </div>
                <button type="button" id="cancel-edit" class="hidden w-full text-[10px] text-gray-500 uppercase tracking-widest">取消修改模式</button>
            </form>
        </div>
    </section>

    <main class="space-y-4">
        <div class="bg-zinc-900/50 rounded-xl border border-zinc-800">
            <div class="p-3 border-b border-zinc-800 flex justify-between items-center text-xs font-bold text-yellow-600">
                <span>NEW LEAD 新開發</span>
                <span id="count-lead" class="bg-yellow-900/30 px-2 py-0.5 rounded">0</span>
            </div>
            <div id="list-lead"></div>
        </div>

        <div class="bg-zinc-900/50 rounded-xl border border-zinc-800">
            <div class="p-3 border-b border-zinc-800 flex justify-between items-center text-xs font-bold text-yellow-600">
                <span>CONTACTED 洽談中</span>
                <span id="count-contacted" class="bg-yellow-900/30 px-2 py-0.5 rounded">0</span>
            </div>
            <div id="list-contacted"></div>
        </div>

        <div class="bg-zinc-900/50 rounded-xl border border-zinc-800">
            <div class="p-3 border-b border-zinc-800 flex justify-between items-center text-xs font-bold text-green-600">
                <span>WON 已成交</span>
                <span id="count-won" class="bg-green-900/30 px-2 py-0.5 rounded">0</span>
            </div>
            <div id="list-won"></div>
        </div>
    </main>

    <script>
        // Firebase 配置 (已整合您提供的內容)
        const firebaseConfig = {
            apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
            authDomain: "holyhairsalon-f73bf.firebaseapp.com",
            databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
            projectId: "holyhairsalon-f73bf",
            storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
            messagingSenderId: "960169055224",
            appId: "1:960169055224:web:82244b5e65983f89bf3c0d",
            measurementId: "G-XS22B43TYM"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const leadsRef = db.ref('leads');

        let localData = {};

        // 1. 即時偵測姓名：自動填入舊資料
        document.getElementById('name').addEventListener('input', function(e) {
            const val = e.target.value.trim();
            if (!val) { hideHint(); return; }
            
            // 在現有資料中尋找同名人
            const match = Object.values(localData).find(item => item.name === val);
            if (match && !document.getElementById('edit-id').value) {
                document.getElementById('contact').value = match.contact;
                document.getElementById('course').value = match.course || "";
                document.getElementById('value').value = match.value || "";
                document.getElementById('stage').value = match.stage;
                showHint();
            } else {
                hideHint();
            }
        });

        function showHint() { document.getElementById('match-hint').classList.remove('hidden'); }
        function hideHint() { document.getElementById('match-hint').classList.add('hidden'); }

        // 2. 儲存與修改
        document.getElementById('lead-form').onsubmit = function(e) {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const id = editId || 'L' + Date.now();
            
            const leadData = {
                id: id,
                name: document.getElementById('name').value.trim(),
                contact: document.getElementById('contact').value.trim(),
                stage: document.getElementById('stage').value,
                course: document.getElementById('course').value,
                value: document.getElementById('value').value || 0,
                updatedAt: Date.now()
            };

            leadsRef.child(id).set(leadData).then(() => {
                this.reset();
                document.getElementById('edit-id').value = "";
                document.getElementById('submit-btn').innerText = "儲存記錄";
                document.getElementById('cancel-edit').classList.add('hidden');
                hideHint();
            });
        };

        // 3. 監聽 Firebase 資料並渲染 UI
        leadsRef.on('value', (snapshot) => {
            localData = snapshot.val() || {};
            renderUI();
        });

        function renderUI() {
            const stages = ['lead', 'contacted', 'won'];
            stages.forEach(s => {
                const listEl = document.getElementById('list-' + s);
                const countEl = document.getElementById('count-' + s);
                listEl.innerHTML = "";
                
                const filtered = Object.values(localData).filter(i => i.stage === s)
                                .sort((a,b) => b.updatedAt - a.updatedAt);
                
                countEl.innerText = filtered.length;

                filtered.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "accordion-item border-b border-zinc-800/50 last:border-0";
                    div.innerHTML = `
                        <div class="p-3 flex justify-between items-center cursor-pointer" onclick="toggleAccordion(this)">
                            <div class="text-sm">
                                <span class="font-bold text-white">${item.name}</span>
                                <span class="text-[10px] text-gray-600 ml-2">${item.course || ''}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-yellow-600 font-mono">$${Number(item.value).toLocaleString()}</span>
                                <span class="chevron text-[8px] text-gray-600 transition-transform">▼</span>
                            </div>
                        </div>
                        <div class="accordion-content bg-black/30">
                            <div class="flex flex-col gap-2">
                                <div class="text-xs text-gray-400">聯絡：${item.contact}</div>
                                <div class="flex gap-2">
                                    <button onclick="editItem('${item.id}')" class="flex-1 py-2 bg-yellow-600/10 text-yellow-500 text-xs rounded border border-yellow-600/20">修改</button>
                                    <button onclick="deleteItem('${item.id}')" class="flex-1 py-2 bg-red-900/10 text-red-500 text-xs rounded border border-red-900/20">刪除</button>
                                </div>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            });
        }

        // 4. 功能函數
        function toggleAccordion(header) {
            const item = header.parentElement;
            const isOpen = item.classList.contains('open');
            document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('open'));
            if (!isOpen) item.classList.add('open');
        }

        function editItem(id) {
            const item = localData[id];
            document.getElementById('edit-id').value = id;
            document.getElementById('name').value = item.name;
            document.getElementById('contact').value = item.contact;
            document.getElementById('course').value = item.course;
            document.getElementById('value').value = item.value;
            document.getElementById('stage').value = item.stage;
            
            document.getElementById('submit-btn').innerText = "確認修改";
            document.getElementById('cancel-edit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteItem(id) {
            if(confirm('確定要刪除這筆尊榮紀錄嗎？')) {
                leadsRef.child(id).remove();
            }
        }

        document.getElementById('cancel-edit').onclick = function() {
            document.getElementById('lead-form').reset();
            document.getElementById('edit-id').value = "";
            this.classList.add('hidden');
            document.getElementById('submit-btn').innerText = "儲存記錄";
        };
    </script>
</body>
</html>
